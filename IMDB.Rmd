---
title: "Predicting IMBD Scores"
author: "Shivani Dedhia, Akhila Pamukuntla, Nafis Chowdhury, Akshita Jain"
output: 
  html_document: default
  pdf_document: default
  fig_width: .5
  fig_height: .5
  fig.align: center
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE , dev = "png", dpi=300)
options(digits = 2)

library(readr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(stringr)
library(ggrepel)
library(reshape2)
library(corrgram)
library(tree)
library(rpart)
library(rpart.plot)
library(randomForest)
library(plotly)
```

## STA 9750 Final Project

## Introduction

Many factors make a movie succesful and profitable. Some of the factors include budget of the movie, actor's and director's popularity, etc. We will find out which factor has the most impact on the movies success and profitability.  

We have the IMDB 5000 movie dataset, which has 28 variables, 5043 movies across 100 years in 66 countries. There are many variables in the dataset such as Director, Actors, Duration, Gross, Budget, Genres, Facebook Likes, etc. 

We will be using some of the modeling technique with associated visualization to identify the most important variables
impacting the success and acceptance of the movie along with the profitability. 

## Hypothesis

```{r combine and clean data, warning=FALSE, echo=FALSE}
IMDB <- read.csv("IMDM_ratings.csv")

imdb <- IMDB[!duplicated(IMDB), ]
imdb <- imdb[!is.na(imdb$gross), ]
imdb <- imdb[!is.na(imdb$budget), ]

imdb <- subset(imdb, select = -c(aspect_ratio))
imdb <- subset(imdb, select = -c(color))
imdb <- subset(imdb, select = -c(movie_imdb_link))
imdb <- subset(imdb, select = -c(language))

# Cleaning the movie title by removing the special character "Â" at the end and some whitespaces.
imdb$movie_title <- gsub("Â", "", as.character(factor(imdb$movie_title)))
clean_title <- str_trim(imdb$movie_title, side = "right")

# Adding profit and ROI
imdb <- imdb %>% mutate(net_profit = gross - budget,return_on_investment = (net_profit/budget)*100)

# replacing all NA's with col average
imdb$facenumber_in_poster[is.na(imdb$facenumber_in_poster)] <- round(mean(imdb$facenumber_in_poster, na.rm = TRUE))

# replacing all 0's with NA's
imdb[,c(5,6,8,13,24,26)][imdb[,c(5,6,8,13,24,26)] == 0] <- NA

# replacing all NA's with col average
imdb$num_critic_for_reviews[is.na(imdb$num_critic_for_reviews)] <- round(mean(imdb$num_critic_for_reviews, na.rm = TRUE))
imdb$duration[is.na(imdb$duration)] <- round(mean(imdb$duration, na.rm = TRUE))
imdb$director_facebook_likes[is.na(imdb$director_facebook_likes)] <- round(mean(imdb$director_facebook_likes, na.rm = TRUE))
imdb$actor_3_facebook_likes[is.na(imdb$actor_3_facebook_likes)] <- round(mean(imdb$actor_3_facebook_likes, na.rm = TRUE))
imdb$actor_1_facebook_likes[is.na(imdb$actor_1_facebook_likes)] <- round(mean(imdb$actor_1_facebook_likes, na.rm = TRUE))
imdb$cast_total_facebook_likes[is.na(imdb$cast_total_facebook_likes)] <- round(mean(imdb$cast_total_facebook_likes, na.rm = TRUE))
imdb$actor_2_facebook_likes[is.na(imdb$actor_2_facebook_likes)] <- round(mean(imdb$actor_2_facebook_likes, na.rm = TRUE))
imdb$movie_facebook_likes[is.na(imdb$movie_facebook_likes)] <- round(mean(imdb$movie_facebook_likes, na.rm = TRUE))

# delete the blank cols in content rating as they cannot be replaced with anything reasonable
imdb <- imdb[!(imdb$content_rating %in% ""),]

# replacing all content_rating with mordern rating system
imdb$content_rating[imdb$content_rating == 'M']   <- 'PG' 
imdb$content_rating[imdb$content_rating == 'GP']  <- 'PG' 
imdb$content_rating[imdb$content_rating == 'X']   <- 'NC-17'
imdb$content_rating[imdb$content_rating == 'Approved']  <- 'R' 
imdb$content_rating[imdb$content_rating == 'Not Rated'] <- 'R' 
imdb$content_rating[imdb$content_rating == 'Passed']    <- 'R' 
imdb$content_rating[imdb$content_rating == 'Unrated']   <- 'R' 
imdb$content_rating <- factor(imdb$content_rating)

levels(imdb$country) <- c(levels(imdb$country), "Others")
imdb$country[(imdb$country != 'USA')&(imdb$country != 'UK')] <- 'Others' 
imdb$country <- factor(imdb$country)

imdb <- imdb %>% mutate(grouped_score =
                     case_when(imdb_score < 4.0 ~ "bad", 
                               imdb_score <= 6 ~ "ok",
                               imdb_score <= 8 ~ "good",
                               imdb_score <= 10 ~ "excellent")
)


```

## Data Exploration

After exploring the data variables such as languages, aspect ratio, imdb movie link and color were removed to reduce bias. As many of these variables had data heavily skewed on one side.Count of movies rated above 7.5 which are considered to be highly recommended. Majority of the movies are rated 7.6 with only a handful rated above 9. The highest rating received by one movie is 9.3. This shows there is not enough data to understand the variables that have the strongest impact on highly rated movies.

IMDB offers a scoring scale that allows users to rate films on a scale of one to ten. It indicates that submitted scores are filtered and weighted in various ways in order to produce a weighted mean that is displayed for each film, series, and so on. So, this means according to this, 
the higher the score is, the better the movie will be. 
So, here most of the movies are between the range of 6.5 to 7.7. We can consider this as good/very good movies. It indicates, the acceptance of these movies are well enough among the movie audiences. 
However, there are obviously some exceptionally phenomenal movies which are rated beyond 8 but we can see that numbers are may be couple of hundreds only. On the other side, the bar chart is very 
skewed which indicates there are also a good number of movies which were upto the expectation of the viewers. However, in general, this is still difficult to predict the important factors behind
these scores.


```{r score_distribution, warning=FALSE, echo=FALSE, out.width="75%"}

ggplot(aes(x=imdb_score), data = imdb) +
  geom_histogram(binwidth = 0.2,aes(fill = ..count..),colour="white",fill="#f3ce13") +
  scale_x_continuous(breaks = 0:10) +
  ggtitle("Imdb Score Distribution") +
  labs(x = "IMDB Score", y = "Count of Movies")

```




```{r imdb_score_table, warning=FALSE, echo=FALSE,out.width="75%"}

imdb %>% group_by(imdb_score) %>% filter(imdb_score > 7.5) %>% count(imdb_score) %>% arrange(desc(n))

```

## Average Imdb Score by Content Rating

Average score for movies by content rating is below 6.6 which is considered a poor imdb score. As per this distribution content rating does not have a strong impact on the imdb score.

Content rating basically tells us about the age group of people who should watch these movies. Content rating does not have strng influence on the imdb score, however, we can see that most of the content ratings are in the range of
6.5 to 7.5. But, there are some outliers categories which are beyond this range. So, it means there is a possibility that these ratings are com9ng from different age groups but we cannot confirm this certainlt with this data. R and PG-13 have the most number of movies which indicates most of the movies are not for under age people but which makes it more interesting is the imdb score of these movies are also very poor and below average. To summarize, a big chank of the movies are restricted ones with poor imdb score.

```{r content_rating chart, warning=FALSE, echo=FALSE,out.width="75%"}

rating_imdb <- imdb %>% group_by(content_rating) %>%
  filter(!is.na(content_rating)) %>%
  summarise(average_imdb_score = mean(imdb_score), num = n())

  ggplot(aes(x=average_imdb_score, y = num, label = content_rating),data = rating_imdb) +
  geom_point() +
  geom_label_repel()

```


## Understanding the distribution of directors and their effect on IMDB score

Directors have been grouped by the number of movies directed. The data has been filtered to only show movies directed above  10 and below 50 remove any anomalies in the data. Directors with more movies could have a higher fan following, credibility and success rate possibly leading to a higher imdb score. 

According to the below distribution, even after filtering, the number of movies for most of the directors are between 10 to 15, few are in the range of 15 to 20 and rest two are absolutely outliers. This indicates that in this time frame, the most naturalistic production of movies by the directors are between 10 to 15 range. The rational can be budget, resources or time constraints etc.


```{r directors, warning=FALSE,echo=FALSE,out.width="75%"}

imdb.directors <- data.frame (imdb %>% 
                                  group_by(director_name) %>%
                                  summarise(count = n())%>%
                                  filter(count >10, count <50))

ggplot(aes(x = director_name, y = count), data = imdb.directors)+
  geom_jitter() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  labs(title="Directors Distribution on Movies",x="Directors",y="Count of Movies")


```


Only a handful of directors have over 15 movies directed in this data set. Steven Spielberg is the only director to have ~ 24 movies directed. The chart below shows average imdb score for directors with 15 or more directed movies. The imdb score is above 5.5 for directors with more than 15 movies. Most directors have recieved a higher imdb score that shows the number of movies directed has a slight impact on the imdb score.



```{r score by director, warning=FALSE, echo=FALSE,out.width="75%"}

avg_score_per_director <- data.frame (imdb %>% 
                                  group_by(director_name) %>%
                                  mutate(count = n(),average_imdb_score = mean(imdb_score))%>%
                                  filter(count >14, count <50))
                                  
  

ggplot(aes(x = director_name, y = average_imdb_score), data = avg_score_per_director)+
  geom_point() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  labs(title="Average Imdb Score by Director",x="Directors",y="Average Imdb Score")

```



## Impact of movie duration for a higher imdb score

The average imdb score is shown compared to the duration of the movie. The duration of the movie increases as the imdb score increases. Duration of the movie is not a strong determinator of the imdb score but has a slight impact on the score. The number of movies rated above 7 increases as the movie duration increases.



## Top 20 movies grouped by genres with the highest imdb score. 



```{r movieduration, warning=FALSE, echo=FALSE, out.width="75%"}

director_group <- group_by(imdb, director_name, genres)
movie_by_director <- summarise(director_group,
                               mean_score = mean(imdb_score))


movie_by_director <- movie_by_director[67:4530,]
movie_by_director <- movie_by_director[with(movie_by_director, order(-mean_score)), ]
movie_by_director <- head(movie_by_director, 20)
ggplot(aes(x = mean_score, y = director_name), data = movie_by_director) +
  geom_point(aes(color = genres), size = 2) + xlab("Mean Score") + 
  ylab("Director Name")+ theme_minimal() + ggtitle('Director, Genres & Scores')


```


```{r movie duration, warning=FALSE, echo=FALSE,out.width="75%"}

ggplot(imdb, aes(x =imdb_score, y =duration,colour = factor(imdb_score)))+
  geom_point() +
  labs(title = "Movie Duration and IMDB score", 
       x = "Imdb Score", y = "Duration") 
```


## Impact of net profit on imdb score.

Movies with a net profit over 200 million has a higher imdb rating. Net profit is one of the strong indicators of a higher imdb score. As the trend below shows higher net profits translates to a higher rating. It could be assumed that the viewrship for movies with higher net profits was higher thus recieved a higher movie rating. 



```{r net profit, warning=FALSE,echo=FALSE,out.width="75%"}

ggplot(aes(x = imdb_score, y=net_profit/1000000 ), data = subset(imdb, net_profit > 1, !is.na(net_profit))) +
  geom_jitter(shape = 21, fill = '#f3ce13') +
  geom_smooth() +
  labs(title = "Net Profit and IMDB score", 
       x = " Imdb Score", y = "Net Profit in $ Million") 

```



## Training the model

The linear model below shows number of voted users, number of critic reviews and duration has the most impact on the imdb score. The R-squared if .27 is extremely low which suggests the relationship between these variables is not linear. Even though they have a strong impact on the imdb score. 

```{r lm, warning=FALSE,echo=FALSE,out.width="75%"}

imdb_train_indices <- sample(1:nrow(imdb),0.8*nrow(imdb))

imdb_train <- imdb %>% slice(imdb_train_indices)

imdb_test <- imdb %>% slice(-imdb_train_indices)

# How is imdb score related to the num of voted users compared to duration

imdb_mod_1 = lm (imdb_score~ duration + num_voted_users + num_critic_for_reviews + movie_facebook_likes,data=imdb_train)
summary(imdb_mod_1)

```


## Random Forest to understand the variable that has the most impact on the imdb score






```{r random forest, warning=FALSE,echo=FALSE,out.width="75%"}

imdb_train <- subset(imdb_train, select = -c(grouped_score))

imdb_rf <-  randomForest(imdb_score ~ ., data=imdb_train,ntree = 100, importance = TRUE, do.trace = 10)
plot(imdb_rf)

importance <- importance(imdb_rf)
importance
varImportance <- data.frame(Variables = row.names(importance), 
                            Importance = round(importance[ ,'IncNodePurity'],2))

# Create a rank variable based on importance
rankImportance <- varImportance %>%
  mutate(Rank = paste0('#',dense_rank(desc(Importance))))

# Use ggplot2 to visualize the relative importance of variables
ggplot(rankImportance, aes(x = reorder(Variables, Importance), 
                           y = Importance, fill = Importance)) +
  geom_bar(stat='identity', fill = "#f3ce13") + 
  geom_text(aes(x = Variables, y = 0.5, label = Rank),
            hjust=0, vjust=0.55, size = 4, colour = 'black') +
  labs(x = 'Variables') +
  coord_flip()

```


# Conclusion

Random Forest took into consideration all the variables from the dataset to understand their impact on the imdb score. Number of voted users is the most important variable to a high imdb score. Followed by duration and facebook like received by the movie. It was surprising to see, actors and directors name were among the least impactful. As one would think directors and actors bring in publicity leading to a higher viewership. 




